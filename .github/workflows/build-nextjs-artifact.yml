name: Build Next.js Artifact

on:
  push:
    branches: [main, production-asset-artifact]
    paths:
      - "controller/**"
      - ".github/workflows/build-nextjs-artifact.yml"
  pull_request:
    branches: [main]
    paths:
      - "controller/**"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build from"
        required: false
        default: "main"

jobs:
  build-nextjs:
    runs-on: windows-latest
    if: github.repository == 'sciencecorp/galago-core'
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.11"
          cache: "npm"
          cache-dependency-path: controller/package-lock.json

      - name: Install dependencies
        working-directory: controller
        run: npm ci
        shell: bash

      - name: Build Next.js app
        working-directory: controller
        run: npm run build
        env:
          NODE_ENV: production
          # Skip data fetching during build in CI
          SKIP_BUILD_STATIC_GENERATION: true
        shell: bash

      - name: Create artifact bundle
        working-directory: controller
        run: |
          # Create artifact directory
          mkdir -p ../nextjs-artifact

          # Verify standalone build exists
          if [ ! -d ".next/standalone" ]; then
            echo "ERROR: Standalone build not found!"
            echo "Make sure next.config.js has: output: 'standalone'"
            exit 1
          fi

          echo "=== Creating artifact from standalone build ==="

          # Debug: Check what's in standalone before copying
          echo ""
          echo "DEBUG: What's in standalone/.next before copy?"
          ls -la .next/standalone/.next/
          echo ""

          # Copy everything from standalone INCLUDING hidden folders
          echo "Copying standalone files..."
          # Use shopt to include hidden files, or use a different approach
          shopt -s dotglob 2>/dev/null || true
          cp -r .next/standalone/* ../nextjs-artifact/
          shopt -u dotglob 2>/dev/null || true

          # Alternative: explicitly copy .next folder if it wasn't copied
          if [ ! -d "../nextjs-artifact/.next" ]; then
            echo "WARNING: .next folder wasn't copied, copying explicitly..."
            cp -r .next/standalone/.next ../nextjs-artifact/
          fi

          # Debug: Check what was copied
          echo ""
          echo "DEBUG: What's in artifact/.next after standalone copy?"
          ls -la ../nextjs-artifact/.next/ || echo "ERROR: .next folder not found!"
          echo ""

          # Standalone doesn't include static files - add them
          echo "Adding static files..."
          if [ -d ".next/static" ]; then
            mkdir -p ../nextjs-artifact/.next/static
            cp -r .next/static/* ../nextjs-artifact/.next/static/
          else
            echo "ERROR: .next/static source folder not found!"
            ls -la .next/
            exit 1
          fi

          # Debug: Final state
          echo ""
          echo "DEBUG: What's in artifact/.next after static copy?"
          ls -la ../nextjs-artifact/.next/
          echo ""

          # Copy public assets
          if [ -d "public" ]; then
            echo "Adding public assets..."
            cp -r public ../nextjs-artifact/public
          fi

          # Copy gen-interfaces
          if [ -d "gen-interfaces" ]; then
            echo "Adding gen-interfaces..."
            cp -r gen-interfaces ../nextjs-artifact/gen-interfaces
          fi

          # === VERIFICATION ===
          echo ""
          echo "=== Artifact Structure ==="
          ls -la ../nextjs-artifact/

          echo ""
          echo "=== Size Breakdown ==="
          du -sh ../nextjs-artifact/* 2>/dev/null || true

          echo ""
          echo "=== .next folder contents ==="
          if [ -d "../nextjs-artifact/.next" ]; then
            ls -la ../nextjs-artifact/.next/
            echo ""
            echo "=== .next subdirectories ==="
            du -sh ../nextjs-artifact/.next/* 2>/dev/null || true
          else
            echo "ERROR: .next folder not found!"
            exit 1
          fi

          echo ""
          echo "=== node_modules size ==="
          if [ -d "../nextjs-artifact/node_modules" ]; then
            du -sh ../nextjs-artifact/node_modules
          else
            echo "WARNING: node_modules not found!"
          fi

          echo ""
          echo "=== Total artifact size ==="
          du -sh ../nextjs-artifact

          echo ""
          echo "=== Verifying required files ==="

          # Check server.js exists
          if [ ! -f "../nextjs-artifact/server.js" ]; then
            echo "ERROR: server.js not found!"
            exit 1
          fi
          echo "✓ server.js found"

          # Check .next/static exists
          if [ ! -d "../nextjs-artifact/.next/static" ]; then
            echo "ERROR: .next/static not found!"
            echo "Contents of .next:"
            ls -la ../nextjs-artifact/.next/
            exit 1
          fi
          echo "✓ .next/static found"

          # Check .next/server exists
          if [ ! -d "../nextjs-artifact/.next/server" ]; then
            echo "ERROR: .next/server not found!"
            echo "Contents of .next:"
            ls -la ../nextjs-artifact/.next/
            exit 1
          fi
          echo "✓ .next/server found"

          echo "✓ All required files present"
        shell: bash

      - name: Create zip archive
        run: |
          cd nextjs-artifact

          # List what we're about to zip (including hidden folders)
          echo "=== Contents to be zipped ==="
          ls -la
          echo ""

          # Use 7zip with explicit inclusion of hidden files
          # -r = recursive, -tzip = zip format, -mx=9 = max compression
          7z a -tzip -r ../nextjs-production-win-x64.zip * .next

          cd ..

          # Move to a clean directory for upload
          mkdir -p artifacts-for-upload
          mv nextjs-production-win-x64.zip artifacts-for-upload/

          echo ""
          echo "=== Final artifact size ==="
          ls -lh artifacts-for-upload/nextjs-production-win-x64.zip

          # Verify .next is in the zip
          echo ""
          echo "=== Verifying zip contents ==="
          7z l artifacts-for-upload/nextjs-production-win-x64.zip | grep -E "(\.next|server\.js|node_modules)" | head -20
        shell: bash

      - name: Calculate checksum
        run: |
          cd artifacts-for-upload
          certutil -hashfile nextjs-production-win-x64.zip SHA256 > nextjs-production-win-x64.zip.sha256
          cat nextjs-production-win-x64.zip.sha256
        shell: bash

      - name: Determine release tag
        id: release_tag
        run: |
          # Get branch name and sanitize it for artifact names
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          BRANCH_NAME="${BRANCH_NAME#refs/pull/}"
          BRANCH_NAME="${BRANCH_NAME%/merge}"

          # Replace invalid characters for artifact names (/, :, <, >, |, *, ?, \r, \n, \, ")
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[\/:<>|*?\\"]/-/g')

          if [ "$BRANCH_NAME" = "main" ]; then
            TAG="nextjs-latest"
          else
            TAG="nextjs-${BRANCH_NAME}-latest"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "safe_branch=$SAFE_BRANCH_NAME" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload artifact (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-production-${{ steps.release_tag.outputs.safe_branch }}
          path: artifacts-for-upload/*
          retention-days: 30
          if-no-files-found: error

      - name: Delete existing release (if exists)
        continue-on-error: true
        run: |
          # Check if release exists before trying to delete
          if gh release view ${{ steps.release_tag.outputs.tag }} >/dev/null 2>&1; then
            echo "Deleting existing release: ${{ steps.release_tag.outputs.tag }}"
            gh release delete ${{ steps.release_tag.outputs.tag }} --yes
          else
            echo "No existing release found, skipping delete"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash

      - name: Create or update release
        run: |
          cd artifacts-for-upload
          gh release create ${{ steps.release_tag.outputs.tag }} \
            nextjs-production-win-x64.zip \
            nextjs-production-win-x64.zip.sha256 \
            --title "Next.js Production Build (${{ steps.release_tag.outputs.branch }})" \
            --notes "Pre-built Next.js artifact from branch ${{ steps.release_tag.outputs.branch }} (commit: ${{ github.sha }})" \
            ${{ steps.release_tag.outputs.branch == 'main' && '--latest' || '--prerelease' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
