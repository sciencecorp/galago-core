#!/usr/bin/env bash

PROTOC_GEN_TS_PATH=".\\controller\\node_modules\\.bin\\protoc-gen-ts_proto"
PROTO_SRC="./interfaces"
WORKING_BRANCH=$(git symbolic-ref --short HEAD)
ENV_NAME="galago-core" 

# Install dependencies for tool servers, controller, and protobuf generator
deps() {
  python_deps
  npm_deps
  npm install -g grpc-tools@1.12.4 ts-proto@1.151.1
}

build_env() {
    echo "Creating conda environment '$ENV_NAME'..."
    mamba create --name $ENV_NAME python=3.9.12 nodejs=18.20.3 -y
    echo "Conda environment '$ENV_NAME' created."
}

run() {
  echo "Launching Tools" 
  python -m tools.launch_tools
}

python_deps() {
  echo "Installing Python Dependencies"
  python -m pip install -r tools/requirements.txt
  for req in tools/*/requirements.txt; do
    python -m pip install -r $req --no-cache-dir || echo "Failed to install $req" >&2 || true
  done
  echo "Python Dependencies Installed"
} 

npm_deps() {
  echo "Installing Node Dependencies"
  (cd controller && npm install)
  echo "Node Dependencies Installed"
}

db(){
  logs_db
  inventory_db
}

logs_db(){
  echo "Creating Log Database"
  python -m tools.db.models.log_models
  echo "Creating Log Types"
  python -m tools.db.log_types_add
}

inventory_db(){
  echo "Creating Inventory Database"
  python -m tools.db.models.inventory_models
  echo "Creating Inventory Types"
  python -m tools.db.instantiate_db
}

#create local redis database for local dev (mac only)
redis() {
  eval "$(/opt/homebrew/bin/brew shellenv)"
  # Check if Homebrew is installed
  if ! command -v brew &> /dev/null; then
    echo "Homebrew not found. Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  else
    echo "Homebrew is already installed."
  fi

  # Install Redis
  if ! command -v redis-server &> /dev/null; then
    echo "Installing Redis..."
    brew install redis
    brew services start redis
    echo "Redis service is running."
  else
    echo "Redis is already installed and running."
  fi
}

test() {
  test_ts
  test_py
}

test_ts() {
  echo "Runnning Node Tests"
  (cd controller && npx prettier . --check && npm run test)
}

test_py() {
  echo "Running Python Tests"
  ruff check .
  mypy . --install-types --non-interactive
}

pytest() {
  pytest tools/tests/ -vv
}

unittest_py() {
  python -m unittest discover -s tools/tests/ -p "*_test.py"
}

# Generate protobuf definitions for Python
proto_py() {
  python -m grpc_tools.protoc \
    -I${PROTO_SRC}/ \
    --python_out=. \
    --pyi_out=. \
    --grpc_python_out=. \
    ${PROTO_SRC}/tools/grpc_interfaces/*.proto
  python -m grpc_tools.protoc \
    -I${PROTO_SRC}/ \
    --python_out=tools/grpc_interfaces/ \
    --pyi_out=tools/grpc_interfaces \
    --grpc_python_out=tools/grpc_interfaces/ \
    ${PROTO_SRC}/*.proto
}

# Clean up all generated files
clean_proto() {
  echo "Cleaning up generated proto files"
  rm -rf controller/gen-interfaces tools/*_pb2*.py*
  mkdir -p controller/gen-interfaces/tools
  echo "Cleaned up generated proto files"
}

# Generate protobuf definitions for TypeScript
proto_ts() {
  mkdir -p ./controller/gen-interfaces
  python -m grpc_tools.protoc \
    -I=${PROTO_SRC}/ \
    --ts_proto_out=./controller/gen-interfaces/ \
    --ts_proto_opt=stringEnums=true \
    --ts_proto_opt=esModuleInterop=true \
    --ts_proto_opt=snakeToCamel=false \
    --ts_proto_opt=outputServices=grpc-js \
    ${PROTO_SRC}/*.proto ${PROTO_SRC}/tools/grpc_interfaces/*.proto
        # --plugin=protoc-gen-ts_proto="${PROTOC_GEN_TS_PATH}.cmd" \
}


proto_ts_v2() {
  mkdir -p ./controller/gen-interfaces
  python -m grpc_tools.protoc \
    -I=${PROTO_SRC}/ \
    --plugin=protoc-gen-ts_proto="${PROTOC_GEN_TS_PATH}.cmd" \
    --ts_proto_out=./controller/gen-interfaces/ \
    --ts_proto_opt=stringEnums=true \
    --ts_proto_opt=esModuleInterop=true \
    --ts_proto_opt=snakeToCamel=false \
    --ts_proto_opt=outputServices=grpc-js \
    ${PROTO_SRC}/*.proto ${PROTO_SRC}/tools/grpc_interfaces/*.proto
}

run(){
  echo "Launching Tools" 
  python -m tools.launch_tools
}

# Generate all protobuf definitions
proto() {
  clean_proto
  proto_py
  proto_ts
}

for cmd in "$@"; do
  set -ex
  $cmd
  set +ex
done

if [ $# -eq 0 ]; then
  echo "No command specified, available commands:"
  for cmd in $(compgen -A function | grep -E '^'); do
    echo "  ${cmd#}"
  done
fi
