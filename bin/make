#!/usr/bin/env bash

PROTOC_GEN_TS_PATH=".\\controller\\node_modules\\.bin\\protoc-gen-ts_proto"
PROTO_SRC="./interfaces"
ENV_NAME="galago-core" 

#Docker commands

prod() {
  echo "Starting production containers..."
  docker-compose up --build -d
  echo "‚úÖ Production containers started!"
}

dev_up() {
  echo "Starting dev containers..."
  docker-compose -f docker-compose.dev.yml up --build
  echo "‚úÖ Dev containers started!"
}

dev_rebuild() {
  echo "Rebuilding dev containers..."
  docker-compose -f docker-compose.dev.yml down
  docker-compose -f docker-compose.dev.yml build
  docker-compose -f docker-compose.dev.yml up --build
  echo "‚úÖ Dev containers rebuilt and started!"
}

dev_down() {
  echo "Stopping dev containers..."
  docker-compose -f docker-compose.dev.yml down
  echo "‚úÖ Dev containers stopped!"
}

dev_logs() {
  docker-compose -f docker-compose.dev.yml logs -f
}

shell_node() {
  echo "Opening shell in Node container..."
  docker-compose -f docker-compose.dev.yml exec galago-web-dev sh
}

shell_python() {
  echo "Opening shell in Python container..."
  docker-compose -f docker-compose.dev.yml exec galago-db-dev sh
}

test_docker() {
  echo "Running all tests in Docker dev containers..."
  test_docker_node
  test_docker_python
  echo "‚úÖ All Docker tests passed!"
}

test_docker_node() {
  echo "Running Node tests in dev container..."
  docker compose exec galago-web-dev test
  if [ $? -eq 0 ]; then
    echo "‚úÖ Node tests passed!"
  else
    echo "‚ùå Node tests failed"
    return 1
  fi
}

test_docker_python() {
  echo "Running Python tests in dev container..."
  docker compose exec db test
  if [ $? -eq 0 ]; then
    echo "‚úÖ Python tests passed!"
  else
    echo "‚ùå Python tests failed"
    return 1
  fi
}

format_docker() {
  echo "Formatting all code in Docker dev containers..."
  format_docker_node
  format_docker_python
  echo "‚úÖ All code formatted!"
}

format_docker_node() {
  echo "Formatting Node code in dev container..."
  docker compose exec galago-web-dev format
  if [ $? -eq 0 ]; then
    echo "‚úÖ Node code formatted!"
  else
    echo "‚ùå Node formatting failed"
    return 1
  fi
}

format_docker_python() {
  echo "Formatting Python code in dev container..."
  docker compose exec db format
  if [ $? -eq 0 ]; then
    echo "‚úÖ Python code formatted!"
  else
    echo "‚ùå Python formatting failed"
    return 1
  fi
}

# Install dependencies for tool servers, controller, and protobuf generator
deps() {
  python_deps
  npm_deps
  npm install -g grpc-tools@1.12.4 ts-proto@1.151.1
}

build_env() {
    echo "Creating conda environment '$ENV_NAME'..."
    mamba create --name $ENV_NAME python=3.9.12 nodejs=18.20.3 -y
    echo "Conda environment '$ENV_NAME' created."
}

python_deps() {
  echo "Installing Python Dependencies"
  python -m pip install -r db/requirements.txt
  python -m pip install grpcio-tools
  python -m pip install black
  echo "Python Dependencies Installed"
} 

npm_deps() {
  echo "Installing Node Dependencies"
  (cd controller && npm install)
  echo "Node Dependencies Installed"
}

#create local redis database for local dev (mac only)
redis() {
  eval "$(/opt/homebrew/bin/brew shellenv)"
  # Check if Homebrew is installed
  if ! command -v brew &> /dev/null; then
    echo "Homebrew not found. Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  else
    echo "Homebrew is already installed."
  fi

  # Install Redis
  if ! command -v redis-server &> /dev/null; then
    echo "Installing Redis..."
    brew install redis
    brew services start redis
    echo "Redis service is running."
  else
    echo "Redis is already installed and running."
  fi
}

test() {
  test_ts
  test_py
}

test_ts() {
  echo "Runnning Node Tests"
  (cd controller && npx prettier . --check && npx tsc --build --clean && npm run test) &&
  build_prod
}

build_prod() {
  echo "Building production assets..."
  npm_deps
  (cd controller && npm run build)
  echo "Production build complete."
}

test_py() {
  echo "Running Python Tests"
  echo "Ruff Check"
  ruff check .
  echo "Mypy Check Db"
  mypy db 
}

unittest_py() {
  python -m unittest discover -s db/tests/ -p "*_test.py"
}

# Clean up all generated files
clean_proto() {
  echo "Cleaning up generated proto files"
  rm -rf controller/gen-interfaces tools/*_pb2*.py*
  mkdir -p controller/gen-interfaces/tools
  echo "Cleaned up generated proto files"
}

# Generate protobuf definitions for TypeScript
proto_ts() {
  mkdir -p ./controller/gen-interfaces
  python -m grpc_tools.protoc \
    -I=${PROTO_SRC}/ \
    --ts_proto_out=./controller/gen-interfaces/ \
    --ts_proto_opt=stringEnums=true \
    --ts_proto_opt=esModuleInterop=true \
    --ts_proto_opt=snakeToCamel=false \
    --ts_proto_opt=outputServices=grpc-js \
    ${PROTO_SRC}/*.proto ${PROTO_SRC}/tools/grpc_interfaces/*.proto
        # --plugin=protoc-gen-ts_proto="${PROTOC_GEN_TS_PATH}.cmd" \
}


proto_ts_v2() {
  mkdir -p ./controller/gen-interfaces
  python -m grpc_tools.protoc \
    -I=${PROTO_SRC}/ \
    --plugin=protoc-gen-ts_proto="${PROTOC_GEN_TS_PATH}.cmd" \
    --ts_proto_out=./controller/gen-interfaces/ \
    --ts_proto_opt=stringEnums=true \
    --ts_proto_opt=esModuleInterop=true \
    --ts_proto_opt=snakeToCamel=false \
    --ts_proto_opt=outputServices=grpc-js \
    ${PROTO_SRC}/*.proto ${PROTO_SRC}/tools/grpc_interfaces/*.proto
}

# Generate all protobuf definitions
proto() {
  clean_proto
  proto_ts
}

format_py() {
  echo "Formatting Python files with Black"
  black .
}

format_ts() {
  echo "Formatting TypeScript/JavaScript files with Prettier"
  (cd controller && npx prettier --write .)
}

format() {
  format_py
  format_ts
  echo "All files formatted!"
}

for cmd in "$@"; do
  set -ex
  $cmd
  set +ex
done

if [ $# -eq 0 ]; then
  echo "No command specified, available commands:"
  echo ""
  echo "üê≥ Development Containers:"
  echo "  dev_up             - Start dev containers"
  echo "  dev_down           - Stop dev containers"
  echo "  dev_rebuild        - Rebuild and restart containers"
  echo "  dev_logs           - Follow container logs"
  echo "  shell_node         - Open shell in Node container"
  echo "  shell_python       - Open shell in Python container"
  echo ""
  echo "üß™ Docker Tests (in dev containers):"
  echo "  test_docker        - Run all tests in Docker"
  echo "  test_docker_node   - Run Node.js tests in Docker"
  echo "  test_docker_python - Run Python tests in Docker"
  echo ""
  echo "‚ú® Docker Formatting (in dev containers):"
  echo "  format_docker        - Format all code in Docker"
  echo "  format_docker_node   - Format Node.js code in Docker"
  echo "  format_docker_python - Format Python code in Docker"
  echo ""
  echo "üíª Native Tests (local):"
  echo "  test               - Run all native tests"
  echo "  test_ts            - Run Node.js tests natively"
  echo "  test_py            - Run Python linting/type checks"
  echo "  unittest_py        - Run Python unit tests"
  echo ""
  echo "‚ú® Native Formatting (local):"
  echo "  format             - Format all code natively"
  echo "  format_ts          - Format TypeScript natively"
  echo "  format_py          - Format Python natively"
  echo ""
  echo "üîß Other Commands:"
  echo "  deps               - Install all dependencies"
  echo "  build_env          - Create conda environment"
  echo "  proto              - Generate protobuf files"
  echo "  build_prod         - Build production assets"
  echo "  redis              - Install/start Redis (Mac only)"
fi